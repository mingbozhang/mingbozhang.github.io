<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>JVM学习——编译OpenJDK – BOB BLOG</title>
    <meta name="description" content="A ton of text to test readability.">
    <meta name="keywords" content="">
    <link rel="canonical" href="http://bowie.site/complie_openJDK/">
        <!-- Twitter Cards -->
    <meta name="twitter:title" content="JVM学习——编译OpenJDK">
    <meta name="twitter:description" content="A ton of text to test readability.">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content="http://bowie.site/assets/img/Logo.png">
    <!-- Open Graph -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="JVM学习——编译OpenJDK">
    <meta property="og:description" content="A ton of text to test readability.">
    <meta property="og:url" content="http://bowie.site/complie_openJDK/">
    <meta property="og:site_name" content="BOB BLOG">
    <meta property="og:image" content="http://bowie.site/assets/img/Logo.png">

    
    
    <!-- Handheld -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicons -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="http://bowie.site/assets/img/favicon/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://bowie.site/assets/img/favicon/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://bowie.site/assets/img/favicon/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://bowie.site/assets/img/favicon/apple-touch-icon-144x144.png">
    <link rel="icon" type="image/png" href="http://bowie.site/assets/img/favicon/favicon.png">
    <link rel="shortcut icon" href="http://bowie.site/assets/img/favicon/favicon.ico">
    <!-- Feed -->
    <link rel="alternate" type="application/rss+xml" title="BOB BLOG" href="http://bowie.site/feed.xml">
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="http://bowie.site/assets/css/main.css">
</head>


<body>
        <nav class="nav">
        <ul class="list">
            
				    
				    <li class="item"><a class="link" href="http://bowie.site/">Home</a></li>
				
				    
				    <li class="item"><a class="link" href="http://bowie.site/blog/">Blog</a></li>
				
				    
				    <li class="item"><a class="link" href="http://bowie.site/projects/">Projects</a></li>
				
				    
				    <li class="item"><a class="link" href="http://bowie.site/about/">About</a></li>
				
        </ul>
    </nav>

    <div class="wrapper">
        <div class="title">
            <h1>JVM学习——编译OpenJDK</h1>
            <h4>22 May 2012</h4>
        </div>
        <div class="article">
            <h1 id="jvmopenjdk">JVM学习——编译OpenJDK</h1>

<p>       最近在学习《深入理解java虚拟机 第二版》这本书。书中第一部分建议大家自己编译OpenJDK。抱着学习态度也来编译个玩一玩。下面进入正题。</p>

<h2 id="section">1.编译环境介绍</h2>
<table>
<tr>
<td>名称</td>
<td>版本</td>
</tr>
<tr>
<td>操作系统</td>
<td> CentOS Linux release 7.1.1503 (Core)</td>
</tr>
<tr>
<td>Linux内核版本</td>
<td>3.10.0-229.el7.x86\_64</td>
</tr>
<tr>
<td>gcc版本 </td>
<td> 4.8.2 20140120 (Red Hat 4.8.2-16) (GCC)</td>
</tr>
<tr>
<td>openJdk版本 </td>
<td>openjdk-7u40</td>
</tr>
</table>
<p>## 2.准备工作
### 2.1下载OpenJDK
打开网站https://jdk7.java.net/source.html<br>
在这里复制链接直接在linux中wget。<br>
wget http://www.java.net/download/openjdk/jdk7u40/promoted/b43/openjdk-7u40-fcs-src-b43-26_aug_2013.zip</p>

<h3 id="section-1">2.2 下载依赖</h3>
<p>具体的依赖要求说明都在README-builds.html 中了，这里直接来命令：<br>
# yum install -y  glibc*<br>
# yum install cups-devel<br>
# yum install -y  alsa*<br>
# yum install -y fontconfig*<br>
# yum install zip*<br>
# yum install  libstdc++-static</p>

<p>解压压缩包,将得到openjdk文件夹<br>
unzip  openjdk-7u40-fcs-src-b43-26_aug_2013.zip<br>
cd openjdk<br>
这里有一份构建说明文档README-builds.html ，建议在windows下面看。后面步骤全靠它了。</p>

<p><strong>安装freetype</strong><br>
下载源码
# wget http://jaist.dl.sourceforge.net/project/freetype/freetype2/2.3.12/freetype-2.3.12.tar.gz<br>
解压源码,编译安装
# tar -zxvf freetype-2.3.12.tar.gz<br>
# cd freetype-2.3.12<br>
# ./configure &amp;&amp; make &amp;&amp; sudo -u root make install</p>

<p><strong>下载并安装ANT</strong><br>
配置ANT环境变量<br>
# wget http://mirrors.hust.edu.cn/apache//ant/binaries/apache-ant-1.9.6-bin.tar.gz<br>
# vi /etc/profile<br>
 加入如下内容：<br>
export ANT_HOME=/opt/openJDKroom/apache-ant-1.9.6<br>
export PATH=$PATH:$ANT_HOME/bin<br>
# source /etc/profile</p>

<p><strong>下载并安装CUPS</strong><br>
wget http://www.cups.org/software/2.1.2/cups-2.1.2-source.tar.bz2<br>
tar  -jxvf  cups-2.1.2-source.tar.bz2<br>
# ./configure &amp;&amp; make &amp;&amp; make install</p>

<h3 id="javahome">2.3 屏蔽已经配置的JAVA_HOME</h3>
<p>下面贴出README-builds.html中原文：<br>
Note that some Linux systems have a habit of pre-populating your environment variables for you,   for example JAVA_HOME might get pre-defined for you to refer to the JDK installed on your Linux   system. You will need to unset JAVA_HOME. It’s a good idea to run env and verify the   environment variables you are getting from the default system settings make sense for building   the OpenJDK. 先检查一下本地是否配置有JAVA_HOME<br>
# env | grep JAVA_HOME<br>
如果有则屏蔽掉。</p>

<h3 id="jdk">2.4 配置引导JDK</h3>
<p>下面贴出README-builds.html中原文：
Bootstrap JDK<br>
All OpenJDK builds require access to the previously released JDK 6, this is often called a   bootstrap JDK. The JDK 6 binaries can be downloaded from Sun’s JDK 6 download site. For build   performance reasons is very important that this bootstrap JDK be made available on the local   disk of the machine doing the build. You should always set ALT_BOOTDIR to point to the location   of the bootstrap JDK installation, this is the directory pathname that contains a bin, lib, and   include It’s also a good idea to also place its bin directory in the PATH environment variable,   although it’s not required.</p>

<p><strong>下载安装Bootstrap</strong> <br>
这里下载JDK 6 Linux 64位jdk-6u45-linux-x64.bin<br>
# chmod +x jdk-6u45-linux-x64.bin<br>
# ./jdk-6u45-linux-x64.bin</p>

<p>安装完毕后，当前目录下会生成jdk1.6.0_45目录，配置ALT_BOOTDIR环境变量为该目录路径。在/etc/profile中  增加如下配置（以实际为准）：<br>
export ALT_BOOTDIR=/opt/openJDKroom/jdk1.6.0_45<br>
# source /etc/profile</p>

<h3 id="altcacertsfile">2.5 配置环境变量ALT_CACERTS_FILE</h3>
<font color="green">
Certificate Authority File (cacert)  

See http://en.wikipedia.org/wiki/Certificate\_Authority for a better understanding of the   Certificate Authority (CA). A certificates file named "cacerts" represents a system-wide   keystore with CA certificates. In JDK and JRE binary bundles, the "cacerts" file contains root   CA certificates from several public CAs (e.g., VeriSign, Thawte, and Baltimore). The source   contain a cacerts file without CA root certificates. Formal JDK builders will need to secure     permission from each public CA and include the certificates into their own custom cacerts file.   Failure to provide a populated cacerts file will result in verification errors of a certificate   chain during runtime. The variable ALT\_CACERTS\_FILE can be used to override the default   location of the cacerts file that will get placed in your build. By default an empty cacerts   file is provided and that should be fine for most JDK developers.  </font>

<p>进入openjdk目录中,查找名称为cacerts的文件：<br>
# cd openjdk<br>
# find ./ -name cacerts<br>
显示结果如下：<br>
[root@localhost openjdk]# find ./ -name cacerts<br>
./jdk/src/share/lib/security/cacerts<br>
打开/etc/profile，将以下内容加入（具体路径根据实际情况）：<br>
export ALT_CACERTS_FILE=/opt/openJDKroom/openjdk/jdk/src/share/lib/security/cacerts</p>

<h2 id="section-2">3.开始编译</h2>
<p>终于要开始编译了！&gt;_&lt;  <br>
README-builds.html中用的是gmake，实际和make是一样的，下面是解释：</p>

<p>gmake是GNU Make的缩写。<br>
Linux系统环境下的make就是GNU Make，之所以有gmake，是因为在别的平台上，make一般被占用，GNU make只  好叫gmake了。<br>
进入到openjdk根目录下，进行编译<br>
cd /opt/openJDKroom/openjdk<br>
gmake sanity<br>
gmake<br>
结果执行报错：</p>
<font color="red">
gmake[6]: Entering directory \`/opt/openJDKroom/openjdk/build/linux-amd64/hotspot/outputdir/linux\_amd64\_compiler2/product'  
gmake[6]: stat: libjvm.so: Too many levels of symbolic links
</font>

<p>进入到/opt/openJDKroom/openjdk/build/linux-amd64/hotspot/outputdir/linux_amd64_compiler2/product目录下有下面链接：<br>
libjvm.so-&gt;libjvm.so<br>
libjvm.so.1-&gt;libjvm.so<br>
明显是由于libjvm.so-&gt;libjvm.so引起的（可以自己做一个实验,不要创建文件，直接执行ln -s file file ,然后cat file就会报这个错）<br>
知道了问题所在，就要给它引用一个真实的so文件。通过find /opt -name libjvm.so命令查找存在该文件的地方，将libjvm.so-&gt;libjvm.so指向真实文件位置。即：<br>
# rm -f libjvm.so<br>
# ln -s  具体libjvm.so文件完成路径   libjvm.so</p>

<p>再次执行gmake。
结果报以下错：</p>
<font color="red">Error: time is more than 10 years from present: 1136059200000  
java.lang.RuntimeException: time is more than 10 years from present: 1136059200000  
      at   build.tools.generatecurrencydata.GenerateCurrencyData.makeSpecialCaseEntry(GenerateCurrencyData.java:285)  
      at   build.tools.generatecurrencydata.GenerateCurrencyData.buildMainAndSpecialCaseTables(GenerateCurrencyData.java:225)  
      at   build.tools.generatecurrencydata.GenerateCurrencyData.main(GenerateCurrencyData.java:154)  </font>

<p>经过查询发现这是一个BUG…..<br>
下面介绍了对应补丁的出处<br>
https://bugs.gentoo.org/show_bug.cgi?id=534118#c3<br>
下面有关于问题原因探讨描述<br>
https://bugs.gentoo.org/show_bug.cgi?id=534118#c7</p>

<p>如果不想仔细看可以直接访问补丁网址：<br>
http://hg.openjdk.java.net/jdk7u/jdk7u/jdk/rev/74a70385c21d#l11.1<br>
将其中的文件内容拷贝下来覆盖到对应文件中。</p>

<p>继续gmake</p>

<p>终于编译成功了！！！<br>
出现下面提示就说明编译完成了<br>
#– Build times ———-<br>
Target all_product_build<br>
Start 2016-01-10 11:18:43<br>
End   2016-01-10 11:52:15<br>
00:00:15 corba<br>
00:00:21 hotspot<br>
00:00:11 jaxp<br>
00:00:20 jaxws<br>
00:32:15 jdk<br>
00:00:10 langtools<br>
00:33:32 TOTAL<br>
-————————</p>

<h2 id="section-3">4.跑一下自己编译的虚拟机</h2>
<p>进入目录<br>
/opt/openJDKroom/openjdk/build/linux-amd64/hotspot/outputdir/linux_amd64_compiler2<br>
下面有好几种优化级别的编译版本：<br>
drwxr-xr-x. 2 root root  4096 Jan  9 16:53 debug<br>
drwxr-xr-x. 2 root root  4096 Jan  9 16:53 fastdebug<br>
drwxr-xr-x. 7 root root  4096 Jan  9 16:56 generated<br>
drwxr-xr-x. 2 root root  4096 Jan  9 16:53 jvmg<br>
drwxr-xr-x. 2 root root  4096 Jan  9 16:53 optimized<br>
drwxr-xr-x. 3 root root 20480 Jan 10 11:19 product<br>
drwxr-xr-x. 2 root root  4096 Jan  9 16:53 profiled<br>
-rw-r–r–. 1 root root  1518 Jan  9 16:53 shared_dirs.lst</p>

<p>进入到product目录中。<br>
这里要在env.sh配置下环境变量，指向共享库</p>
<font color="blue">LD\_LIBRARY\_PATH=.:${JAVA\_HOME}/jre/lib/amd64/native\_threads:${JAVA\_HOME}/jre/lib/amd64:/opt/openJDKroom/openjdk/build/linux-amd64/hotspot/outputdir/linux\_amd64\_compiler2/product  
export LD\_LIBRARY\_PATH</font>

<p>下面贴出我这个文件的完整内容：</p>
<font color="green">
\# Generated by /opt/openJDKroom/openjdk/hotspot/make/linux/makefiles/buildtree.make  
\#: ${JAVA\_HOME:=/opt/openJDKroom/jdk1.6.0\_45}  
JAVA\_HOME=/opt/openJDKroom/openjdk/build/linux-amd64/j2sdk-image  
CLASSPATH=.:${JAVA\_HOME}/jre/lib/rt.jar:${JAVA\_HOME}/jre/lib/i18n.jar  
HOTSPOT\_BUILD\_USER="root in hotspot"  
export JAVA\_HOME CLASSPATH HOTSPOT\_BUILD\_USER

\# add  

LD\_LIBRARY\_PATH=.:${JAVA\_HOME}/jre/lib/amd64/native\_threads:${JAVA\_HOME}/jre/lib/amd64:/opt/openJDKroom/openjdk/build/linux-amd64/hotspot/outputdir/linux\_amd64\_compiler2/product
export LD\_LIBRARY\_PATH  
</font>
<p>下面执行：</p>

<p># source ./env.sh</p>

<p># ./gamma -version</p>

<p>Using java runtime at: /opt/openJDKroom/openjdk/build/linux-amd64/j2sdk-image/jre<br>
openjdk version “1.7.0-internal”<br>
OpenJDK Runtime Environment (build 1.7.0-internal-root_2016_01_10_00_16-b00)<br>
OpenJDK 64-Bit Server VM (build 24.0-b56, mixed mode)</p>

<p>运行成功！！</p>

<p>希望对想要编译openJDK的朋友有个参考。如果有疑问请提出，大家一起学习探讨。&gt;_&lt;</p>

        </div>
    </div>
        <div class="footer">
        BOB BLOG © 2016 <a href="http://bowie.site/feed.xml" target="_blank"><i class="fa fa-fw fa-feed"></i></a>
    </div>

    <script src="http://bowie.site/assets/js/jquery-1.12.2.min.js"></script>
<script src="http://bowie.site/assets/js/jquery.goup.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){
    $.goup({
        trigger: 500,
        bottomOffset: 10,
        locationOffset: 20,
        containerRadius: 0,
        containerColor: '#fff',
        arrowColor: '#000',
        goupSpeed: 'normal'
    });
});
</script>


</body>
</html>
